<!DOCTYPE html>
<html lang="en">
<head>
  <title>ChatGPT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/0/04/ChatGPT_logo.svg">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  
  <style>
    /* --- DARK THEME --- */
    :root { 
      --bg-color: #212121;
      --input-bg: #2f2f2f;
      --text-color: #ececec;
      --text-dim: #b4b4b4;
      --accent: #10a37f;
      --bubble-ai: #2f2f2f;
      --bubble-user: #10a37f; /* Green for user */
    }
    
    * { box-sizing: border-box; }

    body { 
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, sans-serif; 
      margin: 0; background: var(--bg-color); color: var(--text-color); height: 100dvh; 
      display: flex; flex-direction: column; overflow: hidden; 
    }

    .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; background: var(--bg-color); z-index: 100; }
    .hidden { display: none !important; }

    /* --- 1. LOGIN --- */
    #auth-screen { justify-content: center; align-items: center; text-align: center; background: #000; }
    .login-container { width: 320px; padding: 40px 0; }
    .gpt-logo-big { font-size: 45px; margin-bottom: 25px; color: var(--text-color); }
    h2 { font-weight: 600; margin-bottom: 25px; font-size: 32px; }
    
    .input-group { margin-bottom: 15px; text-align: left; }
    .input-label { display: block; font-size: 14px; color: var(--text-dim); margin-bottom: 5px; }
    
    input.auth { width: 100%; padding: 15px; background: #fff; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; outline: none; color: #000; }
    button.auth { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; }

    /* --- 2. HEADER --- */
    #header { 
      padding: 10px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); 
      background: var(--bg-color); display: flex; justify-content: space-between; 
      align-items: center; height: 50px; flex-shrink: 0;
    }
    .model-selector { font-size: 16px; font-weight: 600; color: #d1d5db; display: flex; align-items: center; gap: 5px; cursor: pointer;}
    .new-chat-icon { color: var(--text-color); font-size: 18px; cursor: pointer; }

    /* --- 3. MESSAGES (BUBBLE STYLE) --- */
    #messages { 
      list-style: none; padding: 20px; margin: 0; 
      flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;
    }
    
    .msg-row { 
      display: flex; width: 100%;
    }
    
    /* AI ALIGNMENT (LEFT) */
    .row-ai { justify-content: flex-start; }
    .row-ai .msg-bubble { background: var(--bubble-ai); border-top-left-radius: 2px; }
    .row-ai .avatar { margin-right: 10px; background: var(--accent); }

    /* USER ALIGNMENT (RIGHT) */
    .row-user { justify-content: flex-end; }
    .row-user .msg-bubble { background: var(--bubble-user); border-top-right-radius: 2px; color: white; }
    .row-user .avatar { display: none; } /* Hide user avatar for cleaner look */

    .msg-bubble {
      max-width: 80%; padding: 12px 16px; border-radius: 18px;
      font-size: 16px; line-height: 1.5; position: relative; word-wrap: break-word;
    }

    .avatar { 
      width: 30px; height: 30px; border-radius: 50%; 
      display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 14px; color: white;
    }

    .edit-btn { margin-top: 5px; font-size: 12px; opacity: 0.7; cursor: pointer; display: block; text-align: right;}
    .edit-btn:hover { opacity: 1; }

    .msg-img { max-width: 100%; border-radius: 10px; margin-top: 5px; }
    .doc-link { display: inline-flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 8px; margin-top: 5px; color: inherit; text-decoration: none; }
    audio { height: 30px; margin-top: 5px; max-width: 200px; }

    /* --- 4. INPUT BAR --- */
    #form-container { 
      padding: 15px; background: var(--bg-color); 
      display: flex; justify-content: center; width: 100%;
    }
    
    .input-wrapper {
      width: 100%; max-width: 800px;
      background: var(--input-bg); border-radius: 26px; padding: 5px 10px;
      display: flex; align-items: center; gap: 5px;
      border: 1px solid #424242; transition: 0.2s;
    }
    
    /* Recording State */
    .input-wrapper.recording { border-color: #ef4444; background: #3a2020; }

    .icon-btn {
      background: transparent; color: var(--text-dim); border: none;
      padding: 10px; font-size: 18px; cursor: pointer; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
    }
    .icon-btn:hover { color: white; background: #424242; }

    #input { 
      flex-grow: 1; background: transparent; border: none; 
      color: white; font-size: 16px; outline: none; padding: 10px;
    }

    .send-btn { display: none; } /* Hidden, triggered by Enter */

    /* Context Menu */
    #context-menu { position: fixed; background: #2f2f2f; border: 1px solid #444; border-radius: 8px; display: none; flex-direction: column; width: 120px; z-index: 2000; }
    .ctx-item { padding: 12px; cursor: pointer; color: #ececf1; font-size: 14px; border-bottom: 1px solid #3e3e3e; }
    #menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; z-index: 1999; }

  </style>
</head>
<body>

  <div id="auth-screen" class="screen">
    <div class="login-container">
      <div class="gpt-logo-big"><i class="fas fa-robot"></i></div>
      <h2>Welcome back</h2>
      <div class="input-group">
        <label class="input-label">Email address</label>
        <input id="username" class="auth" type="text" />
      </div>
      <div class="input-group">
        <label class="input-label">Password</label>
        <input id="secret-code" type="password" class="auth" />
      </div>
      <button id="login-btn" class="auth" onclick="login()">Continue</button>
    </div>
  </div>

  <div id="chat-screen" class="screen hidden">
    <div id="header">
      <div class="model-selector">ChatGPT 4.0 <i class="fas fa-chevron-down" style="font-size:12px;"></i></div>
      <i class="fas fa-pen-to-square new-chat-icon" onclick="panic()" title="New Chat"></i>
    </div>
    
    <ul id="messages"></ul>
    
    <div id="form-container">
      <div class="input-wrapper" id="input-box">
        
        <label for="doc-upload" class="icon-btn"><i class="fas fa-paperclip"></i></label>
        <input type="file" id="doc-upload" accept=".pdf,.doc,.docx,.txt" style="display:none" onchange="sendDoc()" />

        <label for="img-upload" class="icon-btn"><i class="far fa-image"></i></label>
        <input type="file" id="img-upload" accept="image/*" style="display:none" onchange="sendImage()" />

        <input id="input" autocomplete="off" placeholder="Ask anything" />
        
        <button id="mic-btn" class="icon-btn"><i class="fas fa-microphone-lines"></i></button>
      </div>
    </div>
  </div>

  <div id="menu-overlay" onclick="closeMenu()"></div>
  <div id="context-menu">
    <div class="ctx-item" onclick="unsend()" style="color:#ef4444;">Delete Message</div>
  </div>

  <script>
    const socket = io();
    let myName = ""; 
    let selectedMsgId = null;

    // --- LOGIN ---
    function login() {
      const btn = document.getElementById('login-btn');
      btn.innerText = "Connecting...";
      
      const code = document.getElementById('secret-code').value;
      const nameInput = document.getElementById('username').value.trim();
      
      if(!code) { alert("Enter password"); btn.innerText = "Continue"; return; }

      if(nameInput.toLowerCase() === 'admin') myName = "ChatGPT";
      else myName = "User";

      socket.emit('join', { code, username: myName });
    }

    socket.on('auth-success', () => {
      document.getElementById('auth-screen').classList.add('hidden');
      document.getElementById('chat-screen').classList.remove('hidden');
      scrollToBottom();
    });

    socket.on('auth-fail', () => { alert("Incorrect login."); document.getElementById('login-btn').innerText = "Continue"; });

    function panic() { window.location.href = "https://www.google.com"; }

    // --- CHAT ---
    const messages = document.getElementById('messages');
    const input = document.getElementById('input');
    
    input.addEventListener("keypress", function(event) {
      if (event.key === "Enter") { 
        event.preventDefault(); 
        if (input.value.trim()) {
          socket.emit('chat message', { text: input.value, type: 'text' });
          input.value = '';
        }
      }
    });

    socket.on('chat message', (msg) => { addMessageToUI(msg); scrollToBottom(); });
    socket.on('load-history', (history) => { messages.innerHTML = ''; history.forEach(addMessageToUI); scrollToBottom(); });

    function scrollToBottom() { setTimeout(() => { messages.scrollTop = messages.scrollHeight; }, 50); }

    function addMessageToUI(msg) {
      const li = document.createElement('li');
      const isAI = (msg.username === "ChatGPT");
      li.className = `msg-row ${isAI ? 'row-ai' : 'row-user'}`;
      li.id = msg._id;
      
      // Only AI gets an avatar
      const avatarHTML = isAI ? `<div class="avatar"><i class="fas fa-robot"></i></div>` : ``;

      let content = "";
      if (msg.type === 'text') content = msg.text;
      else if (msg.type === 'image') content = `<img src="${msg.text}" class="msg-img">`;
      else if (msg.type === 'document') content = `<a class="doc-link" href="${msg.text}" download="${msg.fileName}"><i class="fas fa-file"></i> ${msg.fileName}</a>`;
      else if (msg.type === 'audio') content = `<audio controls src="${msg.text}"></audio>`;

      // Edit Icon
      const editHTML = `<div class="edit-btn" onclick="startEdit('${msg._id}', '${msg.text.replace(/'/g, "\\'")}')"><i class="fas fa-pen"></i></div>`;

      li.innerHTML = `
        ${avatarHTML}
        <div class="msg-bubble">
          ${content}
          ${editHTML}
        </div>
      `;

      li.oncontextmenu = (e) => { e.preventDefault(); selectedMsgId = msg._id; showMenu(e); };
      let pressTimer;
      li.ontouchstart = (e) => { pressTimer = setTimeout(() => { selectedMsgId = msg._id; showMenu(e); }, 500); };
      li.ontouchend = () => clearTimeout(pressTimer);

      messages.appendChild(li);
    }

    function startEdit(msgId, oldText) {
      const newText = prompt("Edit message:", oldText);
      if (newText !== null && newText !== oldText) {
        socket.emit('edit-message', { messageId: msgId, newText });
      }
    }

    // --- UPLOADS ---
    function sendImage() {
      const file = document.getElementById('img-upload').files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (e) => socket.emit('chat message', { text: e.target.result, type: 'image' });
      reader.readAsDataURL(file);
    }
    function sendDoc() {
      const file = document.getElementById('doc-upload').files[0];
      if(!file) return;
      if(file.size > 10 * 1024 * 1024) return alert("File too large");
      const reader = new FileReader();
      reader.onload = (e) => socket.emit('chat message', { text: e.target.result, type: 'document', fileName: file.name });
      reader.readAsDataURL(file);
    }

    // --- VOICE NOTES (Fixed) ---
    let mediaRecorder; 
    let audioChunks = []; 
    const micBtn = document.getElementById('mic-btn'); 
    const inputBox = document.getElementById('input-box');
    let isRecording = false;

    micBtn.onclick = async () => {
      if (!isRecording) {
        // START RECORDING
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.start();
          isRecording = true;
          
          // Visual Feedback
          inputBox.classList.add('recording');
          micBtn.style.color = "#ef4444";
          document.getElementById('input').placeholder = "Recording... Click mic to send";

          audioChunks = [];
          mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
          
          mediaRecorder.onstop = () => {
             const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
             const reader = new FileReader();
             reader.readAsDataURL(audioBlob);
             reader.onloadend = () => {
                socket.emit('chat message', { text: reader.result, type: 'audio' });
             };
          };
        } catch(err) { 
          alert("Microphone permission denied."); 
          console.error(err);
        }
      } else {
        // STOP RECORDING
        if(mediaRecorder) mediaRecorder.stop();
        isRecording = false;
        
        // Remove Visuals
        inputBox.classList.remove('recording');
        micBtn.style.color = "#b4b4b4";
        document.getElementById('input').placeholder = "Ask anything";
      }
    };

    // --- MENU ---
    const menu = document.getElementById('context-menu'); const overlay = document.getElementById('menu-overlay');
    function showMenu(e) {
      let x = e.clientX || e.touches[0].clientX; let y = e.clientY || e.touches[0].clientY;
      menu.style.left = x + 'px'; menu.style.top = y + 'px'; menu.style.display = 'flex'; overlay.style.display = 'block';
    }
    function closeMenu() { menu.style.display = 'none'; overlay.style.display = 'none'; }
    function unsend() { if(selectedMsgId) socket.emit('unsend-message', selectedMsgId); closeMenu(); }

    socket.on('message-unsent', (id) => { const el = document.getElementById(id); if(el) el.remove(); });
    socket.on('message-edited', ({ messageId, newText }) => {
      const el = document.getElementById(messageId);
      if(el) {
         // Update text but remove edit button to prevent glitching
         const bubble = el.querySelector('.msg-bubble');
         // We re-render the bubble content simply
         if(bubble) bubble.innerHTML = newText + `<div class="edit-btn" onclick="startEdit('${messageId}', '${newText.replace(/'/g, "\\'")}')"><i class="fas fa-pen"></i></div>`;
      }
    });

  </script>
</body>
</html>
