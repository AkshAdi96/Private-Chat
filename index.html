<!DOCTYPE html>
<html lang="en">
<head>
  <title>ChatGPT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/0/04/ChatGPT_logo.svg">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  
  <style>
    /* --- DARK THEME --- */
    :root { 
      --bg-color: #212121;
      --input-bg: #2f2f2f;
      --text-color: #ececec;
      --text-dim: #b4b4b4;
      --accent: #10a37f;
      --bubble-ai: #3E3F4B; 
      --bubble-user: #10a37f;
    }
    
    * { box-sizing: border-box; }

    body { 
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, sans-serif; 
      margin: 0; background: var(--bg-color); color: var(--text-color); height: 100dvh; 
      display: flex; flex-direction: column; overflow: hidden; 
    }

    .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; background: var(--bg-color); z-index: 100; }
    .hidden { display: none !important; }

    /* --- 1. LOGIN --- */
    #auth-screen { justify-content: center; align-items: center; text-align: center; background: #000; }
    .login-container { width: 320px; padding: 40px 0; }
    .gpt-logo-big { font-size: 45px; margin-bottom: 25px; color: var(--text-color); }
    h2 { font-weight: 600; margin-bottom: 25px; font-size: 32px; }
    
    .input-group { margin-bottom: 15px; text-align: left; }
    .input-label { display: block; font-size: 14px; color: var(--text-dim); margin-bottom: 5px; }
    
    input.auth { width: 100%; padding: 15px; background: #fff; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; outline: none; color: #000; }
    button.auth { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; }

    /* --- 2. HEADER --- */
    #header { 
      padding: 10px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); 
      background: var(--bg-color); display: flex; justify-content: space-between; 
      align-items: center; height: 50px; flex-shrink: 0;
    }
    .model-selector { font-size: 16px; font-weight: 600; color: #d1d5db; display: flex; align-items: center; gap: 5px; cursor: pointer;}
    .new-chat-icon { color: var(--text-color); font-size: 18px; cursor: pointer; }

    /* --- 3. MESSAGES --- */
    #messages { 
      list-style: none; padding: 20px; margin: 0; 
      flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;
      align-items: center;
    }
    
    .msg-row { display: flex; width: 100%; max-width: 800px; }
    
    .row-user { justify-content: flex-start; }
    .row-user .msg-bubble { background: var(--bubble-user); border-top-left-radius: 2px; color: white; cursor: pointer; }
    .row-user .avatar { display: none; } 

    .row-ai { justify-content: flex-end; }
    .row-ai .msg-bubble { background: var(--bubble-ai); border-top-right-radius: 2px; }
    .row-ai .avatar { margin-left: 10px; background: var(--accent); order: 2; } 

    .msg-bubble {
      max-width: 85%; padding: 12px 16px; border-radius: 18px;
      font-size: 16px; line-height: 1.5; position: relative; word-wrap: break-word; user-select: none;
    }

    .avatar { 
      width: 30px; height: 30px; border-radius: 50%; 
      display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 14px; color: white;
    }

    /* IMAGE STYLES */
    .img-wrapper { position: relative; display: inline-block; cursor: zoom-in; } /* Cursor indicates clickable */
    .msg-img { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; }
    .dl-btn-img {
      position: absolute; bottom: 8px; right: 8px;
      background: rgba(0,0,0,0.6); color: white;
      width: 28px; height: 28px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 14px;
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    /* DOCUMENT STYLES */
    .doc-container {
      display: inline-flex; align-items: center; gap: 10px; 
      background: rgba(0,0,0,0.2); padding: 10px 15px; 
      border-radius: 12px; margin-top: 5px; 
      border: 1px solid rgba(255,255,255,0.1); 
      max-width: 100%;
    }
    .doc-icon { font-size: 20px; color: inherit; flex-shrink: 0; }
    .doc-name { font-size: 14px; text-decoration: none; word-break: break-all; flex-grow: 1; }
    .dl-btn-doc {
      background: rgba(255,255,255,0.1); width: 30px; height: 30px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      cursor: pointer; flex-shrink: 0; margin-left: 5px;
    }
    .dl-btn-doc:active { background: rgba(255,255,255,0.3); }

    /* --- 4. INPUT BAR --- */
    #form-container { 
      padding: 15px; background: var(--bg-color); 
      display: flex; justify-content: center; width: 100%;
    }
    
    .input-wrapper {
      width: 100%; max-width: 800px;
      background: var(--input-bg); border-radius: 26px; padding: 5px 10px;
      display: flex; align-items: center; gap: 8px;
      border: 1px solid #424242; transition: 0.2s;
      flex-wrap: nowrap; 
    }
    
    .icon-btn {
      background: transparent; color: var(--text-dim); border: none;
      padding: 10px; font-size: 18px; cursor: pointer; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    .icon-btn:hover { color: white; background: #424242; }

    #input { 
      flex-grow: 1; background: transparent; border: none; 
      color: white; font-size: 16px; outline: none; padding: 10px 5px;
      min-width: 0;
    }

    .send-btn { 
      background: transparent; color: var(--text-dim); border: none;
      padding: 8px; font-size: 16px; cursor: pointer; border-radius: 8px;
      display: flex; align-items: center; justify-content: center; transition: 0.2s;
      flex-shrink: 0;
    }
    .send-btn:hover { background: #424242; }
    .send-btn.active { background: var(--accent); color: white; }

    /* --- MENU --- */
    #context-menu { position: fixed; background: #2f2f2f; border: 1px solid #444; border-radius: 8px; display: none; flex-direction: column; width: 120px; z-index: 2000; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
    .ctx-item { padding: 12px 15px; cursor: pointer; color: #ececf1; font-size: 14px; border-bottom: 1px solid #3e3e3e; display: flex; align-items: center; gap: 10px; }
    .ctx-item:hover { background: #3e3e3e; }
    #menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; z-index: 1999; }

    /* --- IMAGE PREVIEW MODAL (LIGHTBOX) --- */
    #img-modal {
      display: none; position: fixed; z-index: 3000; 
      left: 0; top: 0; width: 100%; height: 100%; 
      background-color: rgba(0,0,0,0.95); 
      justify-content: center; align-items: center;
      flex-direction: column;
    }
    #img-modal-content {
      max-width: 95%; max-height: 85%; 
      border-radius: 5px; object-fit: contain;
      box-shadow: 0 0 20px rgba(255,255,255,0.1);
    }
    #img-modal-close {
      position: absolute; top: 20px; right: 30px; 
      color: #f1f1f1; font-size: 40px; font-weight: bold; 
      cursor: pointer; user-select: none;
    }
    #img-modal-close:hover { color: var(--accent); }

  </style>
</head>
<body>

  <div id="auth-screen" class="screen">
    <div class="login-container">
      <div class="gpt-logo-big"><i class="fas fa-robot"></i></div>
      <h2>Welcome back</h2>
      <div class="input-group">
        <label class="input-label">Email address</label>
        <input id="username" class="auth" type="text" />
      </div>
      <div class="input-group">
        <label class="input-label">Password</label>
        <input id="secret-code" type="password" class="auth" />
      </div>
      <button id="login-btn" class="auth" onclick="login()">Continue</button>
    </div>
  </div>

  <div id="chat-screen" class="screen hidden">
    <div id="header">
      <div class="model-selector">ChatGPT 4.0 <i class="fas fa-chevron-down" style="font-size:12px;"></i></div>
      <i class="fas fa-pen-to-square new-chat-icon" onclick="panic()" title="New Chat"></i>
    </div>
    
    <ul id="messages"></ul>
    
    <div id="form-container">
      <div class="input-wrapper" id="input-box">
        <label for="doc-upload" class="icon-btn"><i class="fas fa-paperclip"></i></label>
        <input type="file" id="doc-upload" accept=".pdf,.doc,.docx,.txt" style="display:none" onchange="sendDoc()" />
        <label for="img-upload" class="icon-btn"><i class="far fa-image"></i></label>
        <input type="file" id="img-upload" accept="image/*" style="display:none" onchange="sendImage()" />
        <input id="input" autocomplete="off" placeholder="Ask anything" />
        <button id="send-btn" class="send-btn"><i class="fas fa-arrow-up"></i></button>
      </div>
    </div>
  </div>

  <div id="menu-overlay" onclick="closeMenu()"></div>
  <div id="context-menu">
    <div class="ctx-item" onclick="startEdit()"><i class="fas fa-pen"></i> Edit</div>
    <div class="ctx-item" onclick="unsend()" style="color:#ef4444;"><i class="fas fa-trash"></i> Delete</div>
  </div>

  <div id="img-modal" onclick="closeImgModal()">
    <span id="img-modal-close">&times;</span>
    <img id="img-modal-content">
  </div>

  <script>
    const socket = io();
    let myName = ""; 
    let selectedMsgId = null;
    let selectedMsgText = "";

    function login() {
      const btn = document.getElementById('login-btn');
      btn.innerText = "Connecting...";
      
      const code = document.getElementById('secret-code').value;
      const nameInput = document.getElementById('username').value.trim();
      
      if(!code) { alert("Enter password"); btn.innerText = "Continue"; return; }

      if(nameInput.toLowerCase() === 'admin') myName = "ChatGPT";
      else myName = "User";

      socket.emit('join', { code, username: myName });
    }

    socket.on('auth-success', () => {
      document.getElementById('auth-screen').classList.add('hidden');
      document.getElementById('chat-screen').classList.remove('hidden');
      scrollToBottom();
    });

    socket.on('auth-fail', () => { alert("Incorrect login."); document.getElementById('login-btn').innerText = "Continue"; });

    function panic() { window.location.href = "https://www.google.com"; }

    // --- CHAT LOGIC ---
    const messages = document.getElementById('messages');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send-btn');
    
    input.addEventListener('input', () => {
      if (input.value.trim().length > 0) sendBtn.classList.add('active');
      else sendBtn.classList.remove('active');
      socket.emit('typing');
    });

    input.addEventListener("keypress", function(event) {
      if (event.key === "Enter") { 
        event.preventDefault(); 
        sendBtn.click();
      }
    });

    sendBtn.onclick = () => {
      if (input.value.trim()) {
        socket.emit('chat message', { text: input.value, type: 'text' });
        input.value = '';
        sendBtn.classList.remove('active');
      }
    };

    socket.on('chat message', (msg) => { addMessageToUI(msg); scrollToBottom(); });
    socket.on('load-history', (history) => { messages.innerHTML = ''; history.forEach(addMessageToUI); scrollToBottom(); });

    function scrollToBottom() { setTimeout(() => { messages.scrollTop = messages.scrollHeight; }, 50); }

    // --- SAFE DOWNLOAD LOGIC ---
    function downloadBase64File(base64Data, fileName) {
        try {
            const arr = base64Data.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while(n--) u8arr[n] = bstr.charCodeAt(n);
            const blob = new Blob([u8arr], {type: mime});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            setTimeout(() => { document.body.removeChild(link); window.URL.revokeObjectURL(url); }, 100);
        } catch(e) { console.error(e); alert("Download failed."); }
    }

    // --- IMAGE PREVIEW LOGIC ---
    function openImgModal(src) {
        const modal = document.getElementById("img-modal");
        const modalImg = document.getElementById("img-modal-content");
        modal.style.display = "flex";
        modalImg.src = src;
    }
    
    function closeImgModal() {
        document.getElementById("img-modal").style.display = "none";
    }

    function addMessageToUI(msg) {
      const li = document.createElement('li');
      const isAI = (msg.username === "ChatGPT");
      
      li.className = `msg-row ${isAI ? 'row-ai' : 'row-user'}`;
      li.id = msg._id;
      
      const avatarHTML = isAI ? `<div class="avatar"><i class="fas fa-robot"></i></div>` : ``;

      let contentHTML = "";
      
      if (msg.type === 'text') {
          contentHTML = `<span class="bubble-text">${msg.text}</span>`;
      } 
      else if (msg.type === 'image') {
          // --- IMAGE WITH PREVIEW CLICK & DOWNLOAD BTN ---
          const btnId = "dl-img-" + msg._id;
          
          // Note the onclick for the image wrapper triggers the modal
          contentHTML = `
            <div class="img-wrapper" onclick="openImgModal('${msg.text}'); event.stopPropagation();">
               <img src="${msg.text}" class="msg-img">
               <div id="${btnId}" class="dl-btn-img"><i class="fas fa-download"></i></div>
            </div>
          `;
          
          setTimeout(() => {
             // Separate listener for download so it doesn't trigger modal
             document.getElementById(btnId).onclick = (e) => {
                 e.stopPropagation();
                 downloadBase64File(msg.text, "image_" + Date.now() + ".png");
             };
          }, 0);
      } 
      else if (msg.type === 'document') {
          const btnId = "dl-doc-" + msg._id;
          contentHTML = `
            <div class="doc-container">
               <i class="fas fa-file-alt doc-icon"></i>
               <span class="doc-name">${msg.fileName}</span>
               <div id="${btnId}" class="dl-btn-doc"><i class="fas fa-download"></i></div>
            </div>
          `;
          setTimeout(() => {
             document.getElementById(btnId).onclick = (e) => {
                 e.stopPropagation();
                 downloadBase64File(msg.text, msg.fileName);
             };
          }, 0);
      }

      li.innerHTML = `
        ${avatarHTML}
        <div class="msg-bubble">
          ${contentHTML}
        </div>
      `;

      li.onclick = (e) => {
        // Prevent menu if clicking inside image modal area (handled by propagation stop above)
        if (msg.username === myName) {
            e.stopPropagation(); 
            selectedMsgId = msg._id;
            selectedMsgText = msg.text; 
            showMenu(e);
        }
      };

      messages.appendChild(li);
    }

    // --- UPLOADS ---
    function sendImage() {
      const file = document.getElementById('img-upload').files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (e) => socket.emit('chat message', { text: e.target.result, type: 'image' });
      reader.readAsDataURL(file);
    }
    function sendDoc() {
      const file = document.getElementById('doc-upload').files[0];
      if(!file) return;
      if(file.size > 12 * 1024 * 1024) return alert("File too large (Max 12MB)");
      const reader = new FileReader();
      reader.onload = (e) => {
          socket.emit('chat message', { text: e.target.result, type: 'document', fileName: file.name });
      };
      reader.readAsDataURL(file);
    }

    // --- MENU ---
    const menu = document.getElementById('context-menu'); 
    const overlay = document.getElementById('menu-overlay');
    
    function showMenu(e) {
      let x = e.clientX; let y = e.clientY;
      if (x + 120 > window.innerWidth) x = window.innerWidth - 130;
      if (y + 100 > window.innerHeight) y = window.innerHeight - 110;
      menu.style.left = x + 'px'; menu.style.top = y + 'px'; menu.style.display = 'flex'; overlay.style.display = 'block';
    }

    function closeMenu() { menu.style.display = 'none'; overlay.style.display = 'none'; }
    function unsend() { if(selectedMsgId) socket.emit('unsend-message', selectedMsgId); closeMenu(); }

    function startEdit() { 
      if(selectedMsgId) { 
        const newText = prompt("Edit message:", selectedMsgText);
        if(newText !== null && newText !== selectedMsgText) {
            socket.emit('edit-message', { messageId: selectedMsgId, newText }); 
        }
      } 
      closeMenu(); 
    }
    
    socket.on('message-unsent', (id) => { const el = document.getElementById(id); if(el) el.remove(); });
    socket.on('message-edited', ({ messageId, newText }) => {
      const el = document.getElementById(messageId);
      if(el) {
         const bubbleText = el.querySelector('.bubble-text');
         if(bubbleText) bubbleText.innerText = newText;
         if (selectedMsgId === messageId) selectedMsgText = newText;
      }
    });

  </script>
</body>
</html>
